---
import ReportLayout from '../../layouts/ReportLayout.astro';
import {Trees} from '../../components/Trees';
import trees from './2022_build_trees.json' assert {type: "json"};
import type {Race} from '../../components/BlockResults';
import ReportDetails, {Status} from '../../components/ReportDetails.astro';

function capitalize(str: string) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function findOpponentRace(identifier: string, race: string) {
  const opponentRace = identifier
    .split('__')[0]
    .split('-')[1]
    .split(',')
    .find(identifierRace => identifierRace !== capitalize(race));
  return opponentRace || capitalize(race);
}

const RACES = ['Protoss', 'Terran', 'Zerg'];
const generateRaceTree = (race: string) => {
  let raceTrees: {[key in Race]: any} = {};
  Object.entries(trees).forEach(([identifier, tree]) => {
    if (capitalize(race) === identifier.split('-')[0]) {
      const opponentRace = findOpponentRace(identifier, race) as Race;
      raceTrees[opponentRace!] = tree;
    }
  });

  return {[race]: raceTrees};
}

const matchupTrees = RACES.map(race => generateRaceTree(race));
const mappedTrees = matchupTrees.reduce((allTrees, currentTree) => ({
  ...allTrees,
  ...currentTree,
}), {});
---
<ReportLayout>
  <ReportDetails
    publishedAt="2022-01-23"
    updatedAt="2022-01-27"
    status={Status.Released}
    definitions={[
      {
        title: 'Playrate',
        description: 'The percentage of games that include the full opening in the build.',
      },
      {
        title: 'Game Coverage',
        description: 'The percentage of games that use an opening from the top 10 openings. Target coverage is ~80%.',
      },
    ]}
    updates={[
      'Fixed a data issue with builds where morphed buildings (E.g. Orbital, Lair) were recorded based on their completion time instead of start time',
      'Fixed a data issue with Terran builds where flying buildings that landed would be recorded in the build',
      'Tweaked build selection parameters on a per-race and per-matchup basis to extend build length and granularity while preserving coverage',
    ]}
    issues={[{
      title: 'Incorrect Values',
      description: 'Some values are slightly incorrect (E.g. ZvZ winrate is not 50%, matchup totals are off-by-one on different sides). Values are directionally correct and the this is unlikely to significantly affect results. Working on a fix for this issue.',
    }]}
  />
  <Trees trees={mappedTrees} client:load />
</ReportLayout>
